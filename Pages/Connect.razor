@page "/connect"
@rendermode RenderMode.InteractiveServer


<h3>🔌 Connect to Database</h3>

<div class="form-group">
    <label>Server Name:</label>
    <input class="form-control" @bind="ServerName" />
</div>

<div class="form-group">
    <label>Database Name:</label>
    <input class="form-control" @bind="DatabaseName" />
</div>

<div class="mt-3">
    <button class="btn btn-primary" @onclick="TestConnection">🔍 Connect & Load Tables</button>
    <button class="btn btn-secondary ms-2" @onclick="LoadRelationships">🔗 Load Relationships</button>
</div>

@if (!string.IsNullOrEmpty(ResultMessage))
{
    <div class="alert @(IsSuccess ? "alert-success" : "alert-danger") mt-3">
        @ResultMessage
    </div>
}

@if (IsSuccess && Tables?.Any() == true)
{
    <h5 class="mt-4">🗂️ Tables in <b>@DatabaseName</b>:</h5>
    <ul class="list-group mt-2">
        @foreach (var table in Tables)
        {
            <li class="list-group-item">
                <button class="btn btn-link" @onclick="() => LoadTableDetails(table)">
                    @table
                </button>
            </li>
        }
    </ul>
}

@if (!string.IsNullOrEmpty(SelectedTable) && Columns.Any())
{
    <h5 class="mt-4">📋 Columns in <b>@SelectedTable</b>:</h5>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Data Type</th>
                <th>Primary Key</th>
                <th>Foreign Key</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var col in Columns)
            {
                <tr>
                    <td>@col.Name</td>
                    <td>@col.DataType</td>
                    <td>@(col.IsPrimaryKey ? "✅" : "")</td>
                    <td>@(col.IsForeignKey ? "🔗" : "")</td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ShowRelationships && Relationships.Any())
{
    <h5 class="mt-5">🔗 Table Relationships:</h5>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>From Table</th>
                <th>From Column</th>
                <th>→</th>
                <th>To Table</th>
                <th>To Column</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var rel in Relationships)
            {
                <tr>
                    <td>@rel.FromTable</td>
                    <td>@rel.FromColumn</td>
                    <td>➡️</td>
                    <td>@rel.ToTable</td>
                    <td>@rel.ToColumn</td>
                </tr>
            }
        </tbody>
    </table>

    <h5 class="mt-5">🧽 ERD Diagram</h5>
    <div class="border rounded bg-white p-3 my-3" style="overflow: auto; width: 100%; height: 600px;">
        <div id="mermaid-wrapper" style="transform: scale(1); transform-origin: 0 0; transition: transform 0.2s ease;">
            @MermaidCode
        </div>
    </div>
    <div class="mt-2">
        <button class="btn btn-sm btn-secondary me-2" @onclick="ZoomIn">🔍 Zoom In</button>
        <button class="btn btn-sm btn-secondary" @onclick="ZoomOut">🔎 Zoom Out</button>
    </div>
}